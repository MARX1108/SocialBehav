---
title: "Prosocial Analysis"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```


##function definition & library
```{r}
library(caret)
singlehistplot <- function(df,main)
{
  #sprintf("mean = %f ", mean(df))
  hist(df, main)
  qts <- quantile(df,probs=c(.025,.975))
  hist(df)
  abline(v=qts[1],col="red")
  abline(v=qts[2],col="red")
}

histplot <- function(cm_tb)
{
  singlehistplot(cm_tb$Accuracy, main="Accuracy")
  singlehistplot(cm_tb$AIC, main="AIC")
  singlehistplot(cm_tb$`Balanced Accuracy`, main="Balanced Accuracy")
  singlehistplot(cm_tb$Sensitivity, main="Sensitivity")
  singlehistplot(cm_tb$Specificity, main="Specificity")
  singlehistplot(cm_tb$Precision, main="Precision")
  singlehistplot(cm_tb$Recall, main="Recall")
  singlehistplot(cm_tb$F1, main="F1")
}

prosocial_preprocessing <- function(df)
{
  df <- df[complete.cases(df), ]      
  df<- df[(df$prosocial_parent  <= (3)) | (df$prosocial_parent  == 6), ]
  df<- df[(df$prosocial_child <= (3)) | (df$prosocial_child  == 6), ]
  df$prosocial_sum <- df$prosocial_parent+df$prosocial_child
  df <- df[df$prosocial_sum != 9, ]
  df <- df[df$prosocial_sum != 8, ]
  df <- df[df$prosocial_sum != 7, ]
  cut <- df[df$prosocial_sum == 6, ]
  cut <- cut[cut$prosocial_child != 3, ]
  df <- subset(df, !(subjectkey %in% cut$subjectkey))
  df$y <- ifelse(df$prosocial_sum <= (6), 0, 1)
  return(df)
}

twoclasssample <- function(df, n)
{
  truedf <- df[df$y==1,]
  truedf <- truedf[sample(1:nrow(truedf), n, replace = TRUE), ]
  falsedf <- df[df$y==0,]
  falsedf <- falsedf[sample(1:nrow(falsedf), n, replace = TRUE), ]
  finaldf <- rbind(truedf, falsedf)
  return(finaldf)
}

bootstrap_glm <- function(df, T, plot=TRUE)
{
  names <- c("Sensitivity", "Specificity", "Pos Pred Value", "Neg Pred Value", "Precision", "Recall", "F1", "Prevalence", "Detection Rate", "Detection Prevalence", "Balanced Accuracy", 'Accuracy', 'AIC', 'Converged')
  
  cm_tb <- data.frame(matrix(ncol = length(names), nrow = 0))
  colnames(cm_tb) <- names
  
  for (t in 1:T){
    finaldf <- twoclasssample(df, n=200)
    glm.fit <- glm(y ~ ., data = finaldf, family = binomial)
    cm <- confusionMatrix(table(as.numeric(glm.fit$fitted.values>0.5), finaldf$y))
    
    v <- t(cm$byClass)
    v<-append(v, cm$overall[1])
    v<-append(v, glm.fit$aic)
    v<-append(v, glm.fit$converged)
    cm_tb <- rbind(cm_tb, as.data.frame(t(v)))
   
  }
  colnames(cm_tb) <- names 
  if(plot){
    histplot(cm_tb)
  }
  return(cm_tb)
}

singleglm <- function(df)
{
  finaldf<-twoclasssample(df, n=200)
  glm.fit <- glm(y ~ ., data = finaldf, family = binomial)
  summary(glm.fit)
  cm <- confusionMatrix(table(as.numeric(glm.fit$fitted.values>0.5), finaldf$y))
  print(cm)
  print(cm$byClass)
}
```

## EPF
```{r}
df<-prosocial_preprocessing(read.csv('cleandata.csv'))
df <- subset(df, select=-c(X,aggressive_sumscore , prosocial_child, prosocial_parent, interview_date, interview_age, subjectkey, prosocial_sum))
```

```{r}
singleglm(df)
```

```{r}
cm_tb<-bootstrap_glm(df, T=5000)
write.csv(cm_tb,"./final/EPF-glm.csv", row.names = FALSE)
```

 

## Brain
Attribute selection
```{r}
df<-prosocial_preprocessing(read.csv('brain_cb.csv'))
df <- subset(df, select=-c(aggressive_sumscore, prosocial_child, prosocial_parent, subjectkey,prosocial_sum))
```

```{r}
singleglm(df)
```

```{r}
cm_tb<-bootstrap_glm(df, T=5000)
write.csv(cm_tb,"./final/brain-glm.csv", row.names = FALSE)
```

## Brain + EPF
```{r}
df <- merge(x = read.csv('cleandata.csv'), y = read.csv('brain_cb.csv'), by = "subjectkey", all.x = TRUE)
df <- df[complete.cases(df), ]        

df<- df[(df$prosocial_parent.x  <= (3)) | (df$prosocial_parent.x  == 6), ]
df<- df[(df$prosocial_child.x <= (3)) | (df$prosocial_child.x  == 6), ]
df$prosocial_sum <- df$prosocial_parent.x+df$prosocial_child.x
df <- df[df$prosocial_sum != 9, ]
df <- df[df$prosocial_sum != 8, ]
df <- df[df$prosocial_sum != 7, ]
cut <- df[df$prosocial_sum == 6, ]
cut <- cut[cut$prosocial_child.x != 3, ]
df <- subset(df, !(subjectkey %in% cut$subjectkey))
df$y <- ifelse(df$prosocial_sum <= (6), 0, 1)

df <- subset(df, select=-c(X, prosocial_parent.x, prosocial_child.x, interview_date,subjectkey, aggressive_sumscore.x, interview_age, aggressive_sumscore.y, prosocial_child.y, prosocial_parent.y,prosocial_sum))
#write.csv(df, './final/prosocialEPFbrain.csv', row.names = FALSE)
```

```{r}
cm_tb<-bootstrap_glm(df, T=5000)
write.csv(cm_tb,"./final/brain+EPF-glm.csv", row.names = FALSE)
```
