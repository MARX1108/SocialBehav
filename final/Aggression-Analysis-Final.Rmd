---
title: "Aggression Analysis"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```


##function definition & library
```{r}
library(caret)
GlobalT <- 2
singlehistplot <- function(df,main)
{
  #sprintf("mean = %f ", mean(df))
  hist(df, main=main)
  qts <- quantile(df,probs=c(.025,.975))
  hist(df, main=main)
  abline(v=qts[1],col="red")
  abline(v=qts[2],col="red")
}

histplot <- function(cm_tb)
{
  singlehistplot(cm_tb$Accuracy, main="Accuracy")
  singlehistplot(cm_tb$AIC, main="AIC")
  singlehistplot(cm_tb$`Balanced Accuracy`, main="Balanced Accuracy")
  singlehistplot(cm_tb$Sensitivity, main="Sensitivity")
  singlehistplot(cm_tb$Specificity, main="Specificity")
  singlehistplot(cm_tb$Precision, main="Precision")
  singlehistplot(cm_tb$Recall, main="Recall")
  singlehistplot(cm_tb$F1, main="F1")
}

aggression_preprocessing <- function(df)
{
  df <- df[complete.cases(df), ]      
  df<- df[(df$aggressive_sumscore  <= (-2.020650971)) | (df$aggressive_sumscore  >= (0.2168869)), ]
  df$y <- ifelse(df$aggressive_sumscore <= (-2.020650971), 0, 1)
  return(df)
}

twoclasssample <- function(df, n)
{
  truedf <- df[df$y==1,]
  truedf <- truedf[sample(1:nrow(truedf), n, replace = TRUE), ]
  falsedf <- df[df$y==0,]
  falsedf <- falsedf[sample(1:nrow(falsedf), n, replace = TRUE), ]
  finaldf <- rbind(truedf, falsedf)
  return(finaldf)
}

bootstrap_glm <- function(df, T, plot=TRUE, filesname)
{
  names <- c("Sensitivity", "Specificity", "Pos Pred Value", "Neg Pred Value", "Precision", "Recall", "F1", "Prevalence", "Detection Rate", "Detection Prevalence", "Balanced Accuracy", 'Accuracy', 'AIC', 'Converged', 'Test Accuracy')
  
  cm_tb <- data.frame(matrix(ncol = length(names), nrow = 0))
  colnames(cm_tb) <- names
  
  finaldf <- twoclasssample(df, n=4000)
  dt = sort(sample(nrow(finaldf), nrow(finaldf)*.75))
  train<-finaldf[dt,]
  test<-finaldf[-dt,]
  glm.fit <- glm(y ~ ., data = train, family = binomial)
  
  s_tb <- as.data.frame(t(coef(summary(glm.fit))[,4]))
  
  for (t in 1:T){
    finaldf <- twoclasssample(df, n=4000)
    
    dt = sort(sample(nrow(finaldf), nrow(finaldf)*.75))
    train<-finaldf[dt,]
    test<-finaldf[-dt,]

    glm.fit <- glm(y ~ ., data = train, family = binomial)
    
  
    cm <- confusionMatrix(table(as.numeric(glm.fit$fitted.values>0.5),train$y))
    pred <- predict(glm.fit, test)
    cm2 <- confusionMatrix(table(as.numeric(pred>0.5), test$y))
  
    v <- t(cm$byClass)
    v<-append(v, cm$overall[1])
    v<-append(v, glm.fit$aic)
    v<-append(v, glm.fit$converged)
    v<-append(v, cm2$overall[1])

    cm_tb <- rbind(cm_tb, as.data.frame(t(v)))
    s_tb <- rbind(s_tb, as.data.frame(t(coef(summary(glm.fit))[,4])))   
  }
  
  s_tb <- s_tb[2:nrow(s_tb),]
  write.csv(s_tb, file=filesname, row.names = FALSE)
  colnames(cm_tb) <- names 
  if(plot){
    histplot(cm_tb)
  }
  return(cm_tb)
}

singleglm <- function(df)
{
  finaldf<-twoclasssample(df, n=4000)
  glm.fit <- glm(y ~ ., data = finaldf, family = binomial)
  summary(glm.fit)
  cm <- confusionMatrix(table(as.numeric(glm.fit$fitted.values>0.5), finaldf$y))
  print(cm)
  print(cm$byClass)
}
```

## EPF
```{r}
df<-aggression_preprocessing(read.csv('./cleandata.csv'))
df <- subset(df, select=-c(X,aggressive_sumscore , prosocial_child, prosocial_parent, interview_date, interview_age, subjectkey))
```

```{r}
cm_tb<-bootstrap_glm(df, T=GlobalT, filesname = './Aggression-Attributes-EPF.csv')
write.csv(cm_tb,"./Aggression-Results-EPF.csv", row.names = FALSE)
```

## Brain
Attribute selection
```{r}
df<-aggression_preprocessing(read.csv('./brain_cb.csv'))
df <- subset(df, select=-c(aggressive_sumscore, prosocial_child, prosocial_parent, subjectkey))
```

```{r}
cm_tb<-bootstrap_glm(df, T=GlobalT, filesname = './Prosocial-Attributes-brain.csv')
write.csv(cm_tb,"./Prosocial-Results-brain.csv", row.names = FALSE)
```

## Brain + EPF
```{r}
df <- merge(x = read.csv('./cleandata.csv'), y = read.csv('./brain_cb.csv'), by = "subjectkey", all.x = TRUE)
df <- df[complete.cases(df), ]      
df<- df[(df$aggressive_sumscore.x  <= (-2.020650971)) | (df$aggressive_sumscore.x  >= (0.2168869)), ]
df$y <- ifelse(df$aggressive_sumscore.x <= (-2.020650971), 0, 1)

df <- subset(df, select=-c(X, prosocial_parent.x, prosocial_child.x, interview_date,subjectkey, aggressive_sumscore.x, interview_age, aggressive_sumscore.y, prosocial_child.y, prosocial_parent.y,prosocial_sum))
#write.csv(df, './final/prosocialEPFbrain.csv', row.names = FALSE)
```

```{r}
cm_tb<-bootstrap_glm(df, T=GlobalT, filesname = './Prosocial-Attributes-brain+EPF.csv')
write.csv(cm_tb,"./Prosocial-Results-brain+EPF.csv", row.names = FALSE)
```
